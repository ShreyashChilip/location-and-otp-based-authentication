{% extends 'base.html' %}
{% block title %}Attendance Verification{% endblock title %}
{% block body %}
    <!-- Previous HTML remains the same until the OTP form -->
    <h2 class="text-2xl font-semibold mt-4 text-center">Mark Attendance for:</h2>
    <div class="container my-3">
        <div class="alert alert-info">
            <p><strong>Date:</strong> {{ formatted_date }}</p>
            <p><strong>Time:</strong> {{ formatted_time }}</p>
            <p><strong>Subject:</strong> {{ subject }}</p>
        </div>
    
        <div class="row row-cols-1 row-cols-md-2">
            <div class="col mb-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h4 class="card-title">Verify Location</h4>
                        <iframe id="locationIframe" src="/initVerifyLocation" title="Verify Location" class="w-100" style="height: 400px; border: 1px solid #ccc;"></iframe>
                    </div>
                </div>
            </div>

            <!-- OTP Verification Card -->
            <div class="col mb-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h4 class="card-title">Verify OTP</h4>
                        <div class="w-full max-w-md mx-auto">
                            <h2 class="text-xl font-semibold text-gray-700 mb-4">Enter the OTP sent to your email</h2>
                            <form id="otpForm" class="space-y-4">
                                <div>
                                    <label for="otp" class="block text-gray-600 font-medium">OTP:</label>
                                    <div id="otpContainer" class="flex justify-center space-x-2">
                                        <input type="text" maxlength="1" class="otp-box form-control text-center" required>
                                        <input type="text" maxlength="1" class="otp-box form-control text-center" required>
                                        <input type="text" maxlength="1" class="otp-box form-control text-center" required>
                                        <input type="text" maxlength="1" class="otp-box form-control text-center" required>
                                        <input type="text" maxlength="1" class="otp-box form-control text-center" required>
                                        <input type="text" maxlength="1" class="otp-box form-control text-center" required>
                                    </div>
                                </div>
                            </form>
                            <div id="otpMessages" class="mt-4 text-center"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <div class="text-center">
            <button id="submitAttendance" class="btn btn-primary">Submit Attendance</button>
        </div>
    </div>

    <script>
        
        document.addEventListener("DOMContentLoaded", function() {

            if ("OTPCredential" in window) {
                window.addEventListener("DOMContentLoaded", () => {
                    navigator.credentials.get({ otp: { transport: ["sms"] } }).then(otp => {
                        const otpCode = otp.code.match(/(#\d{6})/)[0];
                        alert("Auto-fetched OTP: " + otpCode);
                    }).catch(err => console.error("Error fetching OTP", err));
                });
            }

            const otpInputs = document.querySelectorAll(".otp-box");
            otpInputs[0].focus();

            otpInputs.forEach((input, index) => {
                input.addEventListener("input", function() {
                    if (this.value.length === 1 && index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus();
                    }
                    checkOtpCompletion();
                });
                
                input.addEventListener("keydown", function(e) {
                    if (e.key === "Backspace" && !this.value && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                });
            });

            function checkOtpCompletion() {
                const otp = Array.from(otpInputs).map(input => input.value).join("");
                if (otp.length === otpInputs.length) {
                    verifyOtp(otp);
                }
            }

            function verifyOtp(otp) {
                const messagesDiv = document.getElementById("otpMessages");
                fetch("/verify_otp", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ otp: otp, subject: "{{ subject }}" })
                })
                .then(response => response.json())
                .then(data => {
                    const messageElement = document.createElement("p");
                    messageElement.textContent = data.message;
                    
                    if (data.status === "success") {
                        messageElement.classList.add("text-success");
                        otpInputs.forEach(input => input.disabled = true);
                    } else {
                        messageElement.classList.add("text-danger");
                    }
                    
                    messagesDiv.innerHTML = "";
                    messagesDiv.appendChild(messageElement);
                })
                .catch(error => {
                    const messageElement = document.createElement("p");
                    messageElement.textContent = "Error verifying OTP. Please try again.";
                    messageElement.classList.add("text-danger");
                    messagesDiv.innerHTML = "";
                    messagesDiv.appendChild(messageElement);
                });
            }
        });

        document.getElementById("submitAttendance").addEventListener("click", function() {
            fetch("/submit_user_attendance", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    formatted_date: "{{ formatted_date }}",
                    formatted_time: "{{ formatted_time }}",
                    subject: "{{ subject }}"
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'failed') {
                    alert(data.message);
                }
                if (data.status === 'success') {
                    window.location.replace("/home");
                }
            })
            .catch(error => alert("An error occurred: " + error));
        });
    </script>
{% endblock body %}
